services:
  poltergeist:
    # Use 'build' for local development to include code changes
    build: ..
    # Use 'image' to pull a pre-built version from GitHub Container Registry
    # image: ghcr.io/google/poltergeist:latest
    volumes:
      - ./poltergeist-config.yaml:/app/config.yaml
      - ../test/private_key.pem:/etc/poltergeist/private_key.pem
    environment:
      - POLTERGEIST_PORT=8080
    expose:
      - "8080"

  ingress-proxy:
    image: nginx:alpine
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    ports:
      - "8080:80"
    depends_on:
      - poltergeist

  downstream-app:
    image: alpine
    volumes:
      - ./test-flow.sh:/test-flow.sh:ro
    command: sh -c "apk add --no-cache curl jq && sh /test-flow.sh"
    depends_on:
      - ingress-proxy
